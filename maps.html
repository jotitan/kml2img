<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="lib/jquery-1.11.0.min.js"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCf0e7TC34X6EzkpsvtKyuqebjiosrzwak">
    </script>
</head>
<body>

 <script>
    var key = "AIzaSyCf0e7TC34X6EzkpsvtKyuqebjiosrzwak";
    var bounds = {minX:180,minY:180,maxX:-180,maxY:-180};
    var size = {width:1000,height:800,window:256};
    var markers = [];
	var styles = [];
	var paths = [];
	var zoom = 1;
	var docInfo;
    function loadKML(file){
        $.ajax({url:file,dataType:'xml',success:function(data){
            docInfo = $(data).find('Document')[0];
            loadStyles(docInfo);
			loadInfos(docInfo);
            showImage();
        }});
    }

		function loadStyles(docInfo){
			var stylesXml = $(docInfo).find('Style');
			for(var i = 0 ; i <stylesXml.length ; i++){
				var style = stylesXml[i];
				var id = "#" + style.getAttribute("id");
				var icon = extractValue($(style),'IconStyle > Icon > href');
				if(icon!=null){
					styles[id] = {icon:icon};
				}else{
					var lineStyle = $(style).find('LineStyle');
					if(lineStyle.length > 0){
						var ls = $(lineStyle[0]);
						styles[id] = {color:extractValue(ls,'color'),width:extractValue(ls,'width')};
					}				
				}
			}
		}
	
     function loadInfos(data){
         var points = $(data).find('Placemark');
         for(var i = 0 ; i < points.length ; i++){
		     var styleId = extractValue($(points[i]),'styleUrl');
             var name = extractValue($(points[i]),'name');
             var point = extractValue($(points[i]),'Point > coordinates');
			 if(point != null){
				 var p = point.split(",");
				 var x = parseFloat(parseFloat(p[0]).toFixed(3));
				 var y = parseFloat(parseFloat(p[1]).toFixed(3));
				 updateBounds(x,y);
				 markers.push({x:x,y:y,style:styles[styleId],name:name});
			 }else{
				var line = extractValue($(points[i]),'LineString > coordinates');
				if(line != null){
					var coords = line.split(" ");					
					var pointsLine = coords.map(function(c){
                        //console.log(c)
                        if(c!=null && c.length >5){
                            var pointLine = {lng:parseFloat(parseFloat(c.split(",")[0]).toFixed(3)),lat:parseFloat(parseFloat(c.split(",")[1]).toFixed(3))};
                            updateBounds(pointLine.lng,pointLine.lat,c);
                            return pointLine;
                        }
					});
					paths.push({pointsLine:points,style:styles[styleId]});
					
				}
			 }
         };
		 bounds.minX = bounds.minX-2;
     }
	 	 
	 function extractValue(data,path){
		var datas = data.find(path);
		if(datas.length > 0){
			return datas[0].firstChild.nodeValue;
		}
		return null;
	 }
    var i = 0;
     function updateBounds(x,y,c){
         bounds.minX = Math.min(bounds.minX,x);
         bounds.minY = Math.min(bounds.minY,y);
         bounds.maxX = Math.max(bounds.maxX,x);
         bounds.maxY = Math.max(bounds.maxY,y);

     }
	
	
	function getBoundsFromZoom(lat,lng,zoom){
		var projection = map.getProjection();
		var z = Math.pow(2,zoom);
		var point = projection.fromLatLngToPoint(new google.maps.LatLng(lat,lng));
		var tile = new google.maps.Point(point.x,point.y);
		// On cherche le tile (la place sur la grille de la carte). Grille augmente avec le zoom (2^zoom)
		// Si zoom = 5, map de 32 * 32, 
		tile.x = Math.floor((point.x/256)*z);
		tile.y = Math.floor((point.y/256)*z);
		
		// On cherche les bornes de ce tile
		var p1 = projection.fromPointToLatLng(new google.maps.Point(tile.x*256/z,(tile.y+1)*256/z));
		var p2 = projection.fromPointToLatLng(new google.maps.Point((tile.x+1)*256/z,(tile.y)*256/z));
		
		var deltaLat = p2.lat() - p1.lat();
		var deltaLng = p2.lng() - p1.lng();
		
		// On cherche le rapport avec la dimension de la fenetre
		deltaLat=deltaLat/256*(size.window+10);	// TODO il faut ce decalage
		deltaLng=deltaLng/256*size.window;
		
		return {lat:deltaLat,lng:deltaLng};
	}
	
	function getSizeWindowInKm(){
		/* largeur (longitude) fixe en angle / distance, mais pas en latitude (longueur non conservee) */
		/* Les angles sont conserves */
		var lat = GeoLoc.getDistanceLat(bounds.minY,bounds.maxY) / size.height;
		var lng = GeoLoc.getDistanceLng(bounds.minX,bounds.maxX,bounds.minY) / size.width;
		var max = Math.max(lat,lng);
		var angle = GeoLoc.getAngleLat(max*size.window);
		zoom = Math.round(Math.log(360/angle) / Math.log(2)) -2;
	}
	
	 // http://www.maptiler.org/google-maps-coordinates-tile-bounds-projection/
	 var GeoLoc = {
		degreInKm:111.195,
		rayon:6371,
				
		getAngleLat:function(distance){
			return distance/this.degreInKm;
		},
				
		getDistanceLat:function(latMin,latMax){
			var angleLat = latMax - latMin;
			return angleLat*this.degreInKm;
		},
		getDistanceLng:function(lngMin,lngMax,lat){
			var circle = this.getCircleToLatitude(lat);
			return ((lngMax - lngMin)/360) * circle;			
		},
		
		getCircleToLatitude:function(latitude){
			var adjustRayon = (Math.PI/2 - this.degreeToRad(latitude)) * this.rayon;
			return adjustRayon * 2 * Math.PI;
		},
		degreeToRad : function(alpha){
			return (alpha*Math.PI/180);
		}
	 }
	 
    function showImage(){
		getSizeWindowInKm();
		
		var currentPoint = {lat:bounds.maxY,lng:bounds.minX};
		for(var j = Math.ceil(size.height/size.window) ; j>=0 ;j--){
			currentPoint.lng = bounds.minX;
			var delta = getBoundsFromZoom(currentPoint.lat,currentPoint.lng,zoom);
			for(var i = 0 ; i < Math.ceil(size.width/size.window);i++){            				
				var bds = {minY:parseFloat(currentPoint.lat.toFixed(3)),minX:parseFloat(currentPoint.lng.toFixed(3)),
					maxY:parseFloat((currentPoint.lat+delta.lat).toFixed(3)),maxX:parseFloat((currentPoint.lng + delta.lng).toFixed(3))};
				currentPoint.lng+=delta.lng;				
				var url = buildPartial(bds);
				if(url!=null){
					$('body').append('<img src="' + url + '" style="width:' + size.window + 'px;style:' + size.window + 'px;margin-top:-5px"/>');
				}
            }
			currentPoint.lat-=delta.lat;
			$('body').append('<br/>');
        }	        
    }

    function buildPartial(bds){
        var url = "http://maps.googleapis.com/maps/api/staticmap?size=" + size.window + "x" + size.window + "&maptype=roadmap&sensor=true&key=" + key;
        url+="&zoom=" + zoom + "&center=" + ((bds.minY +bds.maxY)/2)+ "," + ((bds.minX +bds.maxX)/2);
        //url+="&visible=" + bds.minY + "," + bds.minX + "&visible=" + bds.maxY + "," + bds.maxX;
        url+=buildMarkers(bds);
        //console.log(bds);
		//console.log(((bds.minY +bds.maxY)/2)+ "," + ((bds.minX +bds.maxX)/2))
        return url;
    }

    function buildMarkers(bds){
		// Pas d'espacement
        if(markers.length > 0){
			var url = "";
            // Element distant of 10 px
			var pas = ((bds.maxX - bds.minX)/size.window) * 10;
            //console.log(pas)
            var drawMarks = [];
			markers.forEach(function(m){
                if(m.y >= (bds.minY-pas) && m.y < (bds.maxY +pas) && m.x > (bds.minX -pas) && m.x < (bds.maxX + pas)){
					var present = drawMarks.some(function(mark){
                        var lb = {minX:mark.x-pas,maxX:parseFloat(mark.x+pas),minY:mark.y-pas,maxY:parseFloat(mark.y+pas)};
						return m.x >= lb.minX && m.x <=lb.maxX && m.y >= lb.minY && m.y <= lb.maxY;
					});
					if(!present){
       				drawMarks.push(m);
						url+="&markers=" + ((m.style == null || m.style.icon == null)?"color:red":"icon:" + m.style.icon);
						url+="|" + m.y + "," + m.x;
					}
                }
            });
            return url;
        }
        return "";
    }


var map;
$(function(){
map = new google.maps.Map($('#map').get(0),{zoom:8,center:new google.maps.LatLng(0,0)});
google.maps.event.addListener(map, 'projection_changed', function(){
	loadKML("resources/norvege.kml");
});

});

 </script>

<div id="map" style="width:100px:height:100px;visibility:none"></div>

</body>
</html>